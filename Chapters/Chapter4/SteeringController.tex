\section{Steering Controller}\label{sec:steeringController}
The steering controller are gonna be split up in two controllers. One to control the angular movement of the vehicle, with the servo, so the car can follow the right direction and another controller to keep the vehicle on the route. Both controller will be design out from the steering model from \secref{sec:SteeringModel}. As the angular controller works on the first part of the plant, it will be design first.

\input{Chapters/Chapter4/AngularController.tex}

\input{Chapters/Chapter4/DistanceController.tex}

\subsection{Route control}
The steering controllers uses information from the route, that it have to follow. The route is made up by a number of points in the coordinate system from the GOT system, which there is drawn lines between (See \figref{RCfig1}).

\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.7]{figures/stepsGoT}
 	\caption{An example of a route, where the contains 7 points, which the vehicle have to follow.}
 	\label{fig:RCfig1}
\end{figure}

\subsubsection{Angle}
The angular controller needs the angle of the route line, that is added with the output from the distance controller, to be the reference angle. The only information there is know about the line is the start and end point, as it is drawn up between those to point. To calculate the angle of the line, compared to the coordinate system of the GOT system, \eqref{eq:RCeq1} is used.

\begin{flalign}
  \eq{\theta_{line}}{tan^{-1}(\frac{Y_{end}-Y_{start}}{X_{end}-X_{start}}) \cdot \frac{180}{\pi}}\unit{\si{^\circ}}\label{eq:RCeq1}
\end{flalign}

As the output from the inverse tangent is in $rad \cdot s^{-1}$, it is multiple by $\frac{180}{\pi}$ to convert it to degrees. With this equation, zero degrees will be in the direction of the positive x axis and it will go counter clockwise for positive angles and clockwise for negative angles. This give a range from \si{-180^\circ} to \si{180^\circ}, which also is the output from the magnetometer. If it is compared, the angle from the coordinate system for the GOT system, is not equal to the angle, that comes from the magnetometer. The reason for this is that the positive x axis is not going in the same direction as north. Therefore there is needed a offset angle, that rotates the coordinate system, so zero degrees for the coordinate system and the magnetometer is the same direction.

As the magnetometer do not work in the GOT room, this offset angle cannot be measured and therefore can the right angle of the line not be calculated.

\subsubsection{Distance}
The distance controller needs the distance from the vehicle to the route line, as it use this value in its feedback. The distance can be calculated with \eqref{eq:RCeq2}.

\begin{flalign}
  \eq{Distance}{\frac{(a \cdot X_{now}) + (b \cdot Y_{now}) + c)  }{\sqrt{a^2 + b^2}}}\unit{m}\label{eq:RCeq2}
\end{flalign}
\\
\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.8]{figures/DistanceOutLoop}
 	\caption{Illustration of the distance, that is calculated. The line, that comes from the shortest distance, is orthogonal on the route line.}
 	\label{fig:RCfig2}
\end{figure}

\eqref{eq:RCeq2} a standard vector equation to calculate the shortest distance from a point to a line (See \figref{RCfig2}). The a, b and c values can be calculated with \eqref{eq:RCeq3}, \eqref{eq:RCeq4} and \eqref{eq:RCeq5}.

\begin{flalign}
  \eq{a}{Y_{end} - Y_{start}}\unit{m}\label{eq:RCeq3} \\
  \eq{b}{X_{start} - X_{end}}\unit{m}\label{eq:RCeq4} \\
  \eq{c}{X_{end} \cdot Y_{start} - Y_{end} \cdot X_{start}}\unit{m}\label{eq:RCeq5}
\end{flalign}

By using the start and end point for the line, the distance can be calculated. If the distance is negative, the vehicle is on the left side of the line and on the right side, when the distance i positive. With this equation and the measured coordinate for the vehicle, done by the GOT system, the distance the vehicle is away from the car is known and can be used as a error in the distance controller.

\subsubsection{New line}
When the vehicle reach the end point of a line on the route, a new line have to be used for the reference for the angle and distance. The new lines start point will be the last lines end point, so the lines together makes a two step route. Then the next end point is set and the angle can be calculated and the distance measured.

As the GOT system have a precision down to 1 mm, the coordinates to have a precision of 1 mm \todo{Ref to GOT}. The vehicle will not hit the end point with this precision, as the GOT system only give a measurement each 100 ms , and if the vehicle travels with 1,4 $m \cdot s^{-1}$ \todo{ref to velocity controller}, it will travel 140 mm for each measurement, which make the chance for hitting the end point exactly, small. Therefore is the area, which indicates the end of this line of the route, is made bigger. 

\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.25]{figures/SteeringAngularTest.png}
 	\caption{ }
 	\label{fig:RCfig3}
\end{figure}

To smooth out the turns, when there is used a new route line, the area have to have a bigger size. If the area is to small and the new line is orthogonal on the first line, the vehicle will have to drive over the new line, before regulate into the line, as the vehicle cannot turn that fast (See \figref{RCfig3}). If the area is bigger, the vehicle will turn inside to get to the new line. This area is set to a circle around the end point, with a radius of 25 cm. 

With this route planner, the steering controllers will get the angle and the distance to the route. The route is made by a set of points, where there is drawn lines between, that the vehicle will try to drive onto.

\subsection{Complete steering controller}

